<%= javascript_include_tag 'jquery.textcomplete.js', :plugin => 'redmine_mentions' %>
<%= stylesheet_link_tag 'auto_complete.css', :plugin => 'redmine_mentions' %>
<% regex = '/\B'+Setting.plugin_redmine_mentions['trigger']+'(\w*)$/'%>

<script>
  $('#issue_notes').textcomplete([
    {
      <%users= @project.users.delete_if{|u| (u.type != 'User' || u.mail.empty?)}%>
      mentions: <%=  users.collect{|u| "#{u.login}"}.to_json.html_safe %>,
      match: new RegExp(<%=regex%>),
      search: function(term, callback) {
        callback($.map(this.mentions, function(mention) {
          return mention.indexOf(term) === 0 ? mention : null;
        }));
      },
      index: 1,
      replace: function(mention) {
        return '<%=Setting.plugin_redmine_mentions['trigger']%>'+ mention + ' ';
      }
    }
  ]);
</script>